"use strict";exports.ids=["900"],exports.modules={5663:function(e,t,r){r.r(t),r.d(t,{default:()=>ec});var n=r(4464),a=r(1250),i=r(8974),o=r(9963),s=i.z.object({chainId:i.z.string(),assetId:i.z.string(),symbol:i.z.string(),decimals:i.z.number().int().min(0)}),u=i.z.object({source:s,destination:s,amountIn:i.z.string(),amountOut:i.z.string(),effectiveRate:i.z.number().describe("amountOut/amountIn normalized for decimals"),totalFeesUsd:i.z.number().nullable(),quotedAt:i.z.iso.datetime()}),l=i.z.object({maxAmountIn:i.z.string(),slippageBps:i.z.number()}),c=i.z.object({route:i.z.object({source:s,destination:s}),thresholds:i.z.array(l),measuredAt:i.z.iso.datetime()}),f=i.z.object({window:i.z.enum(["24h","7d","30d"]),volumeUsd:i.z.number(),measuredAt:i.z.iso.datetime()}),h=i.z.object({assets:i.z.array(s),measuredAt:i.z.iso.datetime()}),d=i.z.object({route:i.z.object({source:s,destination:s}),maxCapacityUsd:i.z.number().nullable(),optimalRangeUsd:i.z.object({min:i.z.number(),max:i.z.number()}).nullable(),feeEfficiencyScore:i.z.number().min(0).max(100).nullable(),priceImpactBps:i.z.object({at1k:i.z.number().nullable(),at10k:i.z.number().nullable(),at100k:i.z.number().nullable()}),measuredAt:i.z.iso.datetime()}),m=i.z.object({volumes:i.z.array(f),rates:i.z.array(u),liquidity:i.z.array(c),listedAssets:h,routeIntelligence:i.z.array(d).optional()}),y=o.oc.router({getSnapshot:o.oc.route({method:"GET",path:"/snapshot"}).input(i.z.object({routes:i.z.array(i.z.object({source:s,destination:s})).min(1),notionals:i.z.array(i.z.string()).min(1),includeWindows:i.z.array(i.z.enum(["24h","7d","30d"])).default(["24h"]).optional(),includeIntelligence:i.z.boolean().default(!1).optional().describe("Enable advanced route intelligence analysis (capacity, price impact, fee efficiency)")})).output(m).errors(n.CommonPluginErrors),ping:o.oc.route({method:"GET",path:"/ping"}).output(i.z.object({status:i.z.literal("ok"),timestamp:i.z.string().datetime()})).errors(n.CommonPluginErrors)}),p=r(8946);function b(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):e instanceof t}var g=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"calculateEffectiveRate",value:function(e,t,r,n){if(!e||!t||"number"!=typeof r||"number"!=typeof n||r<0||n<0)throw Error("Invalid input parameters for rate calculation");try{var a=new p.A(e).div(new p.A(10).pow(r)),i=new p.A(t).div(new p.A(10).pow(n));if(a.isZero())throw Error("From amount cannot be zero");return i.div(a).toNumber()}catch(e){throw Error("Decimal calculation failed: ".concat(b(e,Error)?e.message:String(e)))}}},{key:"sumFees",value:function(e){if(!Array.isArray(e))throw Error("Fees must be an array");try{return e.reduce(function(e,t){if(!(null==t?void 0:t.amountUSD))return e;var r="string"==typeof t.amountUSD?t.amountUSD:t.amountUSD.toString();return e.plus(new p.A(r))},new p.A(0)).toNumber()}catch(e){throw Error("Fee calculation failed: ".concat(b(e,Error)?e.message:String(e)))}}},{key:"calculateSlippageBps",value:function(e,t){var r=new p.A(e),n=new p.A(t);return r.isZero()?0:r.minus(n).div(r).times(1e4).abs().toNumber()}},{key:"normalizeAmount",value:function(e,t){return new p.A(e).div(new p.A(10).pow(t))}},{key:"denormalizeAmount",value:function(e,t){var r="number"==typeof e?e.toString():e;return new p.A(r).times(new p.A(10).pow(t)).toFixed(0,p.A.ROUND_DOWN)}}],function(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}(t,e),t}(),v=r(1383),w=r.n(v);function S(e,t,r,n,a,i,o){try{var s=e[i](o),u=s.value}catch(e){r(e);return}s.done?t(u):Promise.resolve(u).then(n,a)}function k(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var i=e.apply(t,r);function o(e){S(i,n,a,o,s,"next",e)}function s(e){S(i,n,a,o,s,"throw",e)}o(void 0)})}}function A(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function E(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){A(e,t,r[t])})}return e}function I(e,t){var r,n,a,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},o=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return o.next=s(0),o.throw=s(1),o.return=s(2),"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(s){return function(u){var l=[s,u];if(r)throw TypeError("Generator is already executing.");for(;o&&(o=0,l[0]&&(i=0)),i;)try{if(r=1,n&&(a=2&l[0]?n.return:l[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,l[1])).done)return a;switch(n=0,a&&(l=[2&l[0],a.value]),l[0]){case 0:case 1:a=l;break;case 4:return i.label++,{value:l[1],done:!1};case 5:i.label++,n=l[1],l=[0];continue;case 7:l=i.ops.pop(),i.trys.pop();continue;default:if(!(a=(a=i.trys).length>0&&a[a.length-1])&&(6===l[0]||2===l[0])){i=0;continue}if(3===l[0]&&(!a||l[1]>a[0]&&l[1]<a[3])){i.label=l[1];break}if(6===l[0]&&i.label<a[1]){i.label=a[1],a=l;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(l);break}a[2]&&i.ops.pop(),i.trys.pop();continue}l=t.call(e,i)}catch(e){l=[6,e],n=0}finally{r=a=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}}}var O=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"configure",value:function(e){var t,r,n={maxConcurrent:null!=(t=e.maxConcurrent)?t:5,minTime:null!=(r=e.minTime)?r:200};this.limiter=new(w())(n),this.lastConfig=n}},{key:"getLimiterConfig",value:function(){return this.lastConfig}},{key:"fetchWithRetry",value:function(e){return k(function(e){var t,r,n,a,i=arguments;return I(this,function(o){if(t=this,r=i.length>1&&void 0!==i[1]?i[1]:{},n=i.length>2&&void 0!==i[2]?i[2]:3,a=i.length>3&&void 0!==i[3]?i[3]:1e3,!e||"string"!=typeof e)throw Error("Valid URL is required");if(n<0||a<0)throw Error("maxRetries and baseDelay must be non-negative");try{new URL(e)}catch(t){throw Error("Invalid URL format: ".concat(e))}return[2,this.limiter.schedule(function(){return k(function(){var t,i,o,s,u;return I(this,function(l){switch(l.label){case 0:i=function(i){var s,u,l,c,f,h,d,m,y;return I(this,function(p){var b,g,v,w;switch(p.label){case 0:return p.trys.push([0,6,,9]),s=new AbortController,u=setTimeout(function(){return s.abort()},3e4),[4,fetch(e,(b=E({},r),g=g={signal:s.signal,headers:E({"Content-Type":"application/json"},r.headers)},Object.getOwnPropertyDescriptors?Object.defineProperties(b,Object.getOwnPropertyDescriptors(g)):(function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r})(Object(g)).forEach(function(e){Object.defineProperty(b,e,Object.getOwnPropertyDescriptor(g,e))}),b))];case 1:if(l=p.sent(),clearTimeout(u),l.ok)return[3,4];if(429!==l.status||(f=(c=l.headers.get("retry-after"))?1e3*parseInt(c):t.calculateBackoffDelay(i,a),!(i<n)))return[3,3];return[4,t.sleep(f)];case 2:return p.sent(),[2,"continue"];case 3:throw Error("HTTP ".concat(l.status,": ").concat(l.statusText));case 4:try{if(!(null==(h=l.headers.get("content-type"))?void 0:h.includes("application/json")))throw Error("Response is not JSON")}catch(e){throw Error("Invalid response headers")}return d={},[4,l.json()];case 5:return[2,(d.v=p.sent(),d)];case 6:if(v=m=p.sent(),o=(null!=(w=Error)&&"undefined"!=typeof Symbol&&w[Symbol.hasInstance]?!!w[Symbol.hasInstance](v):v instanceof w)?m:Error(String(m)),!(i<n))return[3,8];return y=t.calculateBackoffDelay(i,a),[4,t.sleep(y)];case 7:p.sent(),p.label=8;case 8:return[3,9];case 9:return[2]}})},s=0,l.label=1;case 1:if(!(s<=n))return[3,4];return t=this,[5,function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}(i(s))];case 2:var c;if("object"==((c=u=l.sent())&&"undefined"!=typeof Symbol&&c.constructor===Symbol?"symbol":typeof c))return[2,u.v];l.label=3;case 3:return s++,[3,1];case 4:throw Error("Request failed after ".concat(n+1," attempts: ").concat(o.message))}})}).call(t)})]})}).apply(this,arguments)}},{key:"calculateBackoffDelay",value:function(e,t){if("number"!=typeof e||"number"!=typeof t||e<0||t<0)return 1e3;var r=t*Math.pow(2,Math.min(e,10)),n=.1*Math.random()*r;return Math.min(r+n,3e4)}},{key:"sleep",value:function(e){return new Promise(function(t){return setTimeout(t,e)})}}],function(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}(t,e),t}();function x(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function C(e,t,r,n,a,i,o){try{var s=e[i](o),u=s.value}catch(e){r(e);return}s.done?t(u):Promise.resolve(u).then(n,a)}function T(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var i=e.apply(t,r);function o(e){C(i,n,a,o,s,"next",e)}function s(e){C(i,n,a,o,s,"throw",e)}o(void 0)})}}function j(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}function z(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function P(e,t,r){return t&&z(e.prototype,t),r&&z(e,r),e}function L(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function D(e,t){var r,n,a,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},o=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return o.next=s(0),o.throw=s(1),o.return=s(2),"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(s){return function(u){var l=[s,u];if(r)throw TypeError("Generator is already executing.");for(;o&&(o=0,l[0]&&(i=0)),i;)try{if(r=1,n&&(a=2&l[0]?n.return:l[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,l[1])).done)return a;switch(n=0,a&&(l=[2&l[0],a.value]),l[0]){case 0:case 1:a=l;break;case 4:return i.label++,{value:l[1],done:!1};case 5:i.label++,n=l[1],l=[0];continue;case 7:l=i.ops.pop(),i.trys.pop();continue;default:if(!(a=(a=i.trys).length>0&&a[a.length-1])&&(6===l[0]||2===l[0])){i=0;continue}if(3===l[0]&&(!a||l[1]>a[0]&&l[1]<a[3])){i.label=l[1];break}if(6===l[0]&&i.label<a[1]){i.label=a[1],a=l;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(l);break}a[2]&&i.ops.pop(),i.trys.pop();continue}l=t.call(e,i)}catch(e){l=[6,e],n=0}finally{r=a=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}}}A(O,"limiter",new(w())({maxConcurrent:5,minTime:200})),A(O,"lastConfig",{maxConcurrent:5,minTime:200});var R=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3;j(this,e),L(this,"cache",new Map),L(this,"ttlMs",void 0),L(this,"maxSize",void 0),this.ttlMs=t,this.maxSize=r}return P(e,[{key:"get",value:function(e){var t=this.cache.get(e);if(t)return Date.now()>t.expiresAt?void this.cache.delete(e):t.value}},{key:"set",value:function(e,t){if(this.cache.size>=this.maxSize){var r=this.cache.keys().next().value;void 0!==r&&this.cache.delete(r)}this.cache.set(e,{value:t,expiresAt:Date.now()+this.ttlMs})}},{key:"has",value:function(e){return void 0!==this.get(e)}},{key:"clear",value:function(){this.cache.clear()}},{key:"stats",value:function(){var e=Date.now(),t=!0,r=!1,n=void 0;try{for(var a,i=this.cache.entries()[Symbol.iterator]();!(t=(a=i.next()).done);t=!0){var o,s=(o=a.value,function(e){if(Array.isArray(e))return e}(o)||function(e,t){var r,n,a=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=a){var i=[],o=!0,s=!1;try{for(a=a.call(e);!(o=(r=a.next()).done)&&(i.push(r.value),2!==i.length);o=!0);}catch(e){s=!0,n=e}finally{try{o||null==a.return||a.return()}finally{if(s)throw n}}return i}}(o,2)||function(e,t){if(e){if("string"==typeof e)return x(e,2);var r=Object.prototype.toString.call(e).slice(8,-1);if("Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r)return Array.from(r);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return x(e,2)}}(o,2)||function(){throw TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),u=s[0],l=s[1];e>l.expiresAt&&this.cache.delete(u)}}catch(e){r=!0,n=e}finally{try{t||null==i.return||i.return()}finally{if(r)throw n}}return{size:this.cache.size,maxSize:this.maxSize,ttlMs:this.ttlMs}}}]),e}(),U=function(){function e(){j(this,e),L(this,"pending",new Map)}return P(e,[{key:"deduplicate",value:function(e,t){return T(function(){var r,n,a;return D(this,function(i){return(r=this,n=this.pending.get(e))?[2,n]:(a=t().finally(function(){r.pending.delete(e)}),this.pending.set(e,a),[2,a])})}).call(this)}},{key:"clear",value:function(){this.pending.clear()}},{key:"pendingCount",value:function(){return this.pending.size}}]),e}(),M=function(){function e(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2;j(this,e),L(this,"failureThreshold",void 0),L(this,"cooldownMs",void 0),L(this,"successThreshold",void 0),L(this,"state",void 0),L(this,"failureCount",void 0),L(this,"successCount",void 0),L(this,"nextAttemptTime",void 0),this.failureThreshold=t,this.cooldownMs=r,this.successThreshold=n,this.state="CLOSED",this.failureCount=0,this.successCount=0,this.nextAttemptTime=0}return P(e,[{key:"execute",value:function(e){return T(function(){var t,r,n;return D(this,function(a){switch(a.label){case 0:if(t=Date.now(),"OPEN"===this.state){if(t<this.nextAttemptTime)throw Error("Circuit breaker is OPEN - service is unavailable");this.state="HALF_OPEN",this.successCount=0}a.label=1;case 1:return a.trys.push([1,3,,4]),[4,e()];case 2:return r=a.sent(),this.onSuccess(),[2,r];case 3:throw n=a.sent(),this.onFailure(),n;case 4:return[2]}})}).call(this)}},{key:"onSuccess",value:function(){this.failureCount=0,"HALF_OPEN"===this.state&&(this.successCount++,this.successCount>=this.successThreshold&&(this.state="CLOSED",this.successCount=0))}},{key:"onFailure",value:function(){this.failureCount++,this.successCount=0,("HALF_OPEN"===this.state||this.failureCount>=this.failureThreshold)&&(this.state="OPEN",this.nextAttemptTime=Date.now()+this.cooldownMs)}},{key:"getState",value:function(){return{state:this.state,failureCount:this.failureCount,successCount:this.successCount}}},{key:"reset",value:function(){this.state="CLOSED",this.failureCount=0,this.successCount=0,this.nextAttemptTime=0}}]),e}();function B(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function q(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}function N(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function F(e,t,r){return t&&N(e.prototype,t),r&&N(e,r),e}function _(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var V=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info";q(this,e),_(this,"context",void 0),_(this,"minLevel",void 0),this.context=t,this.minLevel=r}return F(e,[{key:"shouldLog",value:function(e){var t=["debug","info","warn","error"];return t.indexOf(e)>=t.indexOf(this.minLevel)}},{key:"formatLog",value:function(e){var t=e.metadata?" ".concat(JSON.stringify(e.metadata)):"";return"[".concat(e.timestamp,"] [").concat(e.level.toUpperCase(),"] [").concat(e.context,"] ").concat(e.message).concat(t)}},{key:"log",value:function(e,t,r){if(this.shouldLog(e)){var n={timestamp:new Date().toISOString(),level:e,message:t,context:this.context,metadata:r},a=this.formatLog(n);switch(e){case"debug":case"info":console.log(a);break;case"warn":console.warn(a);break;case"error":console.error(a)}}}},{key:"debug",value:function(e,t){this.log("debug",e,t)}},{key:"info",value:function(e,t){this.log("info",e,t)}},{key:"warn",value:function(e,t){this.log("warn",e,t)}},{key:"error",value:function(e,t){this.log("error",e,t)}},{key:"child",value:function(t){return new e("".concat(this.context,":").concat(t),this.minLevel)}},{key:"setLevel",value:function(e){this.minLevel=e}}]),e}(),K=function(){function e(){q(this,e),_(this,"startTime",void 0),_(this,"marks",new Map),this.startTime=Date.now()}return F(e,[{key:"mark",value:function(e){this.marks.set(e,Date.now())}},{key:"elapsed",value:function(){return Date.now()-this.startTime}},{key:"measure",value:function(e,t){var r=this.marks.get(e),n=this.marks.get(t);if(r&&n)return n-r}},{key:"getMetadata",value:function(){var e={totalMs:this.elapsed()},t=!0,r=!1,n=void 0;try{for(var a,i=this.marks.entries()[Symbol.iterator]();!(t=(a=i.next()).done);t=!0){var o,s=(o=a.value,function(e){if(Array.isArray(e))return e}(o)||function(e,t){var r,n,a=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=a){var i=[],o=!0,s=!1;try{for(a=a.call(e);!(o=(r=a.next()).done)&&(i.push(r.value),2!==i.length);o=!0);}catch(e){s=!0,n=e}finally{try{o||null==a.return||a.return()}finally{if(s)throw n}}return i}}(o,2)||function(e,t){if(e){if("string"==typeof e)return B(e,2);var r=Object.prototype.toString.call(e).slice(8,-1);if("Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r)return Array.from(r);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return B(e,2)}}(o,2)||function(){throw TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),u=s[0],l=s[1];e["".concat(u,"Ms")]=l-this.startTime}}catch(e){r=!0,n=e}finally{try{t||null==i.return||i.return()}finally{if(r)throw n}}return e}}]),e}();function H(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function Q(e,t,r,n,a,i,o){try{var s=e[i](o),u=s.value}catch(e){r(e);return}s.done?t(u):Promise.resolve(u).then(n,a)}function W(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var i=e.apply(t,r);function o(e){Q(i,n,a,o,s,"next",e)}function s(e){Q(i,n,a,o,s,"throw",e)}o(void 0)})}}function G(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}function $(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function J(e,t,r){return t&&$(e.prototype,t),r&&$(e,r),e}function Y(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Z(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):e instanceof t}function X(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){Y(e,t,r[t])})}return e}function ee(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r,n,a=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=a){var i=[],o=!0,s=!1;try{for(a=a.call(e);!(o=(r=a.next()).done)&&(i.push(r.value),!t||i.length!==t);o=!0);}catch(e){s=!0,n=e}finally{try{o||null==a.return||a.return()}finally{if(s)throw n}}return i}}(e,t)||er(e,t)||function(){throw TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function et(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}function er(e,t){if(e){if("string"==typeof e)return H(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);if("Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r)return Array.from(r);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return H(e,t)}}function en(e,t){var r,n,a,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},o=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return o.next=s(0),o.throw=s(1),o.return=s(2),"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(s){return function(u){var l=[s,u];if(r)throw TypeError("Generator is already executing.");for(;o&&(o=0,l[0]&&(i=0)),i;)try{if(r=1,n&&(a=2&l[0]?n.return:l[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,l[1])).done)return a;switch(n=0,a&&(l=[2&l[0],a.value]),l[0]){case 0:case 1:a=l;break;case 4:return i.label++,{value:l[1],done:!1};case 5:i.label++,n=l[1],l=[0];continue;case 7:l=i.ops.pop(),i.trys.pop();continue;default:if(!(a=(a=i.trys).length>0&&a[a.length-1])&&(6===l[0]||2===l[0])){i=0;continue}if(3===l[0]&&(!a||l[1]>a[0]&&l[1]<a[3])){i.label=l[1];break}if(6===l[0]&&i.label<a[1]){i.label=a[1],a=l;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(l);break}a[2]&&i.ops.pop(),i.trys.pop();continue}l=t.call(e,i)}catch(e){l=[6,e],n=0}finally{r=a=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}}}function ea(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}var ei=function(){function e(t,r){G(this,e),Y(this,"maxTokens",void 0),Y(this,"refillRate",void 0),Y(this,"tokens",void 0),Y(this,"lastRefill",void 0),this.maxTokens=t,this.refillRate=r,this.tokens=t,this.lastRefill=Date.now()}return J(e,[{key:"acquire",value:function(){return W(function(){var e;return en(this,function(t){switch(t.label){case 0:if(this.refill(),this.tokens>=1)return this.tokens-=1,[2];return e=1/this.refillRate*1e3,[4,new Promise(function(t){return setTimeout(t,e)})];case 1:return t.sent(),this.tokens=0,[2]}})}).call(this)}},{key:"refill",value:function(){var e=Date.now(),t=(e-this.lastRefill)/1e3*this.refillRate;this.tokens=Math.min(this.maxTokens,this.tokens+t),this.lastRefill=e}}]),e}(),eo=function(){function e(t,r,n,a){var i,o,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:10;G(this,e),Y(this,"dlnApiBase",void 0),Y(this,"defillamaBaseUrl",void 0),Y(this,"apiKey",void 0),Y(this,"timeout",void 0),Y(this,"logger",void 0),Y(this,"rateLimiter",void 0),Y(this,"MAX_RETRIES",3),Y(this,"RETRY_DELAYS",[1e3,2e3,4e3]),Y(this,"DEBRIDGE_LLAMA_ID","20"),Y(this,"quoteCache",new R(3e5)),Y(this,"volumeCache",null),Y(this,"VOLUME_CACHE_TTL",6e5),Y(this,"tokenListCache",new Map),Y(this,"deduplicator",new U),Y(this,"dlnCircuit",new M(5,6e4)),this.dlnApiBase=this.sanitizeHttpUrl(t,e.DEFAULT_BASE_URL),this.defillamaBaseUrl=this.sanitizeHttpUrl(r,e.DEFAULT_DEFILLAMA_BASE_URL),this.apiKey=null!=(o=null==n||null==(i=n.trim)?void 0:i.call(n))?o:"not-required",this.timeout=a,this.rateLimiter=new ei(s,s),this.logger=new V("deBridge:Service",("undefined"!=typeof process?process.env.LOG_LEVEL:"info")||"info"),console.log("[deBridge] Service configuration",{dlnApiBase:this.dlnApiBase,defillamaBaseUrl:this.defillamaBaseUrl,timeout:this.timeout,maxRequestsPerSecond:s})}return J(e,[{key:"getSnapshot",value:function(e){var t,r,n=this;return(null==e||null==(t=e.routes)?void 0:t.length)&&(null==e||null==(r=e.notionals)?void 0:r.length)?a.Effect.tryPromise({try:function(){return W(function(){var t,r,n,a,i,o,s,u;return en(this,function(l){switch(l.label){case 0:t=new K,this.logger.info("Snapshot fetch started",{routeCount:e.routes.length,notionalCount:e.notionals.length,windows:e.includeWindows,includeIntelligence:e.includeIntelligence||!1}),l.label=1;case 1:return l.trys.push([1,5,,6]),t.mark("fetchStart"),[4,Promise.all([this.getVolumes(e.includeWindows||["24h"]),this.getRates(e.routes,e.notionals),this.getLiquidityDepth(e.routes),this.getListedAssets(e.routes)])];case 2:if(n=(r=ee.apply(void 0,[l.sent(),4]))[0],a=r[1],i=r[2],o=r[3],!e.includeIntelligence)return[3,4];return this.logger.info("Fetching route intelligence",{routeCount:e.routes.length}),[4,this.getRouteIntelligence(e.routes)];case 3:s=l.sent(),l.label=4;case 4:var c,f;return t.mark("fetchEnd"),this.logger.info("Snapshot fetch completed",(c=X({},t.getMetadata()),f=f={volumeCount:n.length,rateCount:a.length,liquidityCount:i.length,assetCount:o.assets.length,intelligenceCount:(null==s?void 0:s.length)||0},Object.getOwnPropertyDescriptors?Object.defineProperties(c,Object.getOwnPropertyDescriptors(f)):(function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r})(Object(f)).forEach(function(e){Object.defineProperty(c,e,Object.getOwnPropertyDescriptor(f,e))}),c)),[2,X({volumes:n,rates:a,liquidity:i,listedAssets:o},s&&{routeIntelligence:s})];case 5:throw u=l.sent(),this.logger.error("Snapshot fetch failed",{error:Z(u,Error)?u.message:String(u),elapsed:t.elapsed()}),Error("Snapshot fetch failed: ".concat(Z(u,Error)?u.message:String(u)));case 6:return[2]}})}).call(n)},catch:function(e){return Error("Failed to fetch snapshot: ".concat(Z(e,Error)?e.message:String(e)))}}):a.Effect.fail(Error("Routes and notionals are required"))}},{key:"getVolumes",value:function(e){return W(function(){var t,r,n,a,i,o,s,u,l,c,f,h;return en(this,function(d){switch(d.label){case 0:return d.trys.push([0,2,,3]),[4,this.fetchDefiLlamaVolumes()];case 1:if(!(t=d.sent()))return this.logger.warn("No volume data available from DefiLlama"),[2,[]];r=[],n=new Date().toISOString(),a=!0,i=!1,o=void 0;try{for(s=e[Symbol.iterator]();!(a=(u=s.next()).done);a=!0){switch(l=u.value,c=void 0,l){case"24h":c=t.lastDailyVolume;break;case"7d":c=t.weeklyVolume;break;case"30d":c=t.monthlyVolume}void 0!==c&&(r.push({window:l,volumeUsd:c,measuredAt:n}),this.logger.info("Volume fetched",{window:l,volumeUsd:c}))}}catch(e){i=!0,o=e}finally{try{a||null==s.return||s.return()}finally{if(i)throw o}}return[2,r];case 2:return h=Z(f=d.sent(),Error)?f.message:String(f),this.logger.error("Failed to fetch volumes from DefiLlama",{error:h}),[2,[]];case 3:return[2]}})}).call(this)}},{key:"getRates",value:function(e,t){return W(function(){var r,n,a,i,o,s,u,l,c,f,h,d,m,y,p,b;return en(this,function(v){switch(v.label){case 0:if(r=this,!(null==e?void 0:e.length)||!(null==t?void 0:t.length))throw Error("Routes and notionals are required for rate fetching");this.logger.info("Fetching rates",{routeCount:e.length,notionalCount:t.length}),n=[],a=!0,i=!1,o=void 0,v.label=1;case 1:v.trys.push([1,12,13,14]),s=e[Symbol.iterator](),v.label=2;case 2:if(a=(u=s.next()).done)return[3,11];if(!(null==(l=u.value)?void 0:l.source)||!(null==l?void 0:l.destination))return this.logger.warn("Invalid route structure, skipping",{route:l}),[3,10];c=!0,f=!1,h=void 0,v.label=3;case 3:v.trys.push([3,8,9,10]),m=function(){var e,t,a,i,o,s,u,c,f,h,m,y,b,v,w,S,k,A;return en(this,function(E){switch(E.label){case 0:if(!(e=p.value)||isNaN(Number(e)))return d.logger.warn("Invalid notional, skipping",{notional:e}),[2,"continue"];E.label=1;case 1:if(E.trys.push([1,5,,6]),t="".concat(l.source.chainId,"-").concat(l.source.assetId,"-").concat(l.destination.chainId,"-").concat(l.destination.assetId,"-").concat(e),a=d.quoteCache.get(t),i=void 0,!a)return[3,2];return d.logger.debug("Quote cache hit",{cacheKey:t}),i=a,[3,4];case 2:return(o=new URL("".concat(d.dlnApiBase,"/dln/order/create-tx"))).searchParams.set("srcChainId",l.source.chainId),o.searchParams.set("srcChainTokenIn",l.source.assetId),o.searchParams.set("srcChainTokenInAmount",e),o.searchParams.set("dstChainId",l.destination.chainId),o.searchParams.set("dstChainTokenOut",l.destination.assetId),o.searchParams.set("dstChainTokenOutAmount","auto"),o.searchParams.set("prependOperatingExpenses","true"),[4,d.dlnCircuit.execute(function(){return r.deduplicator.deduplicate(t,function(){return O.fetchWithRetry(o.toString(),{headers:r.apiKey?{Authorization:"Bearer ".concat(r.apiKey)}:{}})})})];case 3:i=E.sent(),d.quoteCache.set(t,i),d.logger.debug("Quote fetched and cached",{cacheKey:t}),E.label=4;case 4:if(!(null==i?void 0:i.estimation))throw Error("Invalid quote response structure");if(s=i.estimation.srcChainTokenIn,u=i.estimation.dstChainTokenOut,c=s.amount,h=null!=(f=u.recommendedAmount)?f:u.amount,!c||!h)throw Error("Missing amount data in quote estimation");return y=null!=(m=s.approximateUsdValue)?m:s.originApproximateUsdValue,w=null!=(v=null!=(b=u.recommendedApproximateUsdValue)?b:u.approximateUsdValue)?v:u.maxTheoreticalApproximateUsdValue,S=null,null!=y&&null!=w&&(S=Math.max(y-w,0)),k=g.calculateEffectiveRate(c,h,l.source.decimals,l.destination.decimals),n.push({source:l.source,destination:l.destination,amountIn:c,amountOut:h,effectiveRate:k,totalFeesUsd:S,quotedAt:new Date().toISOString()}),d.logger.debug("Rate calculated",{route:"".concat(l.source.symbol,"->").concat(l.destination.symbol),notional:e,effectiveRate:k,totalFeesUsd:S,inUsd:y,outUsd:w}),[3,6];case 5:return A=E.sent(),d.logger.error("Failed to get rate for route",{route:"".concat(l.source.symbol,"->").concat(l.destination.symbol),notional:e,error:Z(A,Error)?A.message:"Unknown error"}),[3,6];case 6:return[2]}})},y=t[Symbol.iterator](),v.label=4;case 4:if(c=(p=y.next()).done)return[3,7];return d=this,[5,ea(m())];case 5:v.sent(),v.label=6;case 6:return c=!0,[3,4];case 7:return[3,10];case 8:return b=v.sent(),f=!0,h=b,[3,10];case 9:try{c||null==y.return||y.return()}finally{if(f)throw h}return[7];case 10:return a=!0,[3,2];case 11:return[3,14];case 12:return b=v.sent(),i=!0,o=b,[3,14];case 13:try{a||null==s.return||s.return()}finally{if(i)throw o}return[7];case 14:return this.logger.info("Rates fetched",{rateCount:n.length}),[2,n]}})}).call(this)}},{key:"getLiquidityDepth",value:function(e){return W(function(){var t,r,n,a,i,o,s,u,l,c,f,h,d,m,y,p,b,g,v,w,S,k,A,E,I,O,x;return en(this,function(C){switch(C.label){case 0:if(!(null==e?void 0:e.length))return this.logger.warn("No routes provided for liquidity depth"),[2,[]];t=[],r=!0,n=!1,a=void 0,C.label=1;case 1:C.trys.push([1,8,9,10]),i=e[Symbol.iterator](),C.label=2;case 2:if(r=(o=i.next()).done)return[3,7];if(!(null==(s=o.value)?void 0:s.source)||!(null==s?void 0:s.destination))return this.logger.warn("Invalid route structure for liquidity, skipping",{route:s}),[3,6];C.label=3;case 3:C.trys.push([3,5,,6]),u=void 0;try{l=BigInt(s.source.decimals),u=(1000n*Math.pow(10n,l)).toString()}catch(e){return this.logger.error("Invalid decimals, skipping route",{decimals:s.source.decimals,route:"".concat(s.source.symbol,"->").concat(s.destination.symbol),error:Z(e,Error)?e.message:String(e)}),[3,6]}return[4,this.fetchQuoteWithRetry(s.source,s.destination,u)];case 4:if(!(f=null==(c=C.sent())?void 0:c.estimation))return this.logger.warn("No estimation in quote response",{route:"".concat(s.source.symbol,"->").concat(s.destination.symbol)}),[3,6];if(h=f.srcChainTokenIn,d=f.dstChainTokenOut,y=null!=(m=null==h?void 0:h.amount)?m:u,b=null!=(p=null==d?void 0:d.recommendedAmount)?p:null==d?void 0:d.amount,v=null!=(g=null==d?void 0:d.maxTheoreticalAmount)?g:b,!y||!b)return this.logger.warn("Missing amount data in quote",{route:"".concat(s.source.symbol,"->").concat(s.destination.symbol)}),[3,6];if(w=y,v&&"0"!==b)try{S=BigInt(y),k=BigInt(b),A=BigInt(v),k>0n&&(w=(S*A/k).toString())}catch(e){E=Z(e,Error)?e.message:String(e),this.logger.warn("Failed to compute max source for liquidity",{error:E})}return t.push({route:s,thresholds:[{maxAmountIn:y,slippageBps:50},{maxAmountIn:w,slippageBps:100}],measuredAt:new Date().toISOString()}),this.logger.debug("Liquidity depth calculated",{route:"".concat(s.source.symbol,"->").concat(s.destination.symbol),srcAmount:y,maxSource:w,ratio:v&&"0"!==b?(Number(v)/Number(b)).toFixed(2):"N/A"}),[3,6];case 5:return O=Z(I=C.sent(),Error)?I.message:String(I),this.logger.error("Failed to fetch liquidity for route",{route:"".concat(s.source.symbol,"->").concat(s.destination.symbol),error:O}),[3,6];case 6:return r=!0,[3,2];case 7:return[3,10];case 8:return x=C.sent(),n=!0,a=x,[3,10];case 9:try{r||null==i.return||i.return()}finally{if(n)throw a}return[7];case 10:return[2,t]}})}).call(this)}},{key:"fetchQuoteWithRetry",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:3;return W(function(){var a,i,o,s,u,l,c;return en(this,function(f){switch(f.label){case 0:i=function(r){var i,o,l,c,f,h,d,m,y,p;return en(this,function(b){switch(b.label){case 0:return b.trys.push([0,7,,10]),[4,a.rateLimiter.acquire()];case 1:return b.sent(),i=Date.now(),[4,fetch(s.toString(),{headers:X({Accept:"application/json"},a.apiKey&&"not-required"!==a.apiKey?{"x-api-key":a.apiKey}:{}),signal:AbortSignal.timeout(a.timeout)})];case 2:if(o=b.sent(),l=Date.now()-i,o.ok)return[3,5];if(!(r<n&&(o.status>=500||429===o.status)))return[3,4];return c=u[r]||4e3,a.logger.warn("Quote API error, retrying",{status:o.status,attempt:r+1,maxRetries:n,delayMs:c,source:e.symbol,destination:t.symbol}),[4,new Promise(function(e){return setTimeout(e,c)})];case 3:case 8:return b.sent(),[2,"continue"];case 4:return a.logger.warn("Quote API error, no retry",{status:o.status,attempt:r+1,source:e.symbol,destination:t.symbol}),[2,{v:null}];case 5:return[4,o.json()];case 6:if(!(null==(f=b.sent())?void 0:f.estimation))return a.logger.warn("Quote response missing estimation",{source:e.symbol,destination:t.symbol,attempt:r+1}),[2,{v:null}];return a.logger.debug("Quote fetched successfully",{source:e.symbol,destination:t.symbol,latencyMs:l,attempt:r+1}),[2,{v:f}];case 7:if(m=(d=Z(h=b.sent(),Error)?h.message:String(h)).includes("timeout")||d.includes("aborted"),y=d.includes("fetch")||d.includes("network"),!(r<n&&(m||y)))return[3,9];return p=u[r]||4e3,a.logger.warn("Quote request failed, retrying",{error:d,attempt:r+1,maxRetries:n,delayMs:p,source:e.symbol,destination:t.symbol}),[4,new Promise(function(e){return setTimeout(e,p)})];case 9:return a.logger.error("Quote request failed permanently",{url:s.toString(),error:d,attempt:r+1,source:e.symbol,destination:t.symbol}),[2,{v:null}];case 10:return[2]}})},o="0x1111111111111111111111111111111111111111",(s=new URL("".concat(this.dlnApiBase,"/dln/order/create-tx"))).searchParams.set("srcChainId",e.chainId),s.searchParams.set("srcChainTokenIn",e.assetId),s.searchParams.set("srcChainTokenInAmount",r),s.searchParams.set("dstChainId",t.chainId),s.searchParams.set("dstChainTokenOut",t.assetId),s.searchParams.set("dstChainTokenOutRecipient",o),s.searchParams.set("dstChainTokenOutAmount","auto"),s.searchParams.set("dstChainOrderAuthorityAddress",o),s.searchParams.set("srcChainOrderAuthorityAddress",o),s.searchParams.set("prependOperatingExpenses","true"),u=[1e3,2e3,4e3],l=0,f.label=1;case 1:if(!(l<=n))return[3,4];return a=this,[5,ea(i(l))];case 2:if("object"===et(c=f.sent()))return[2,c.v];f.label=3;case 3:return l++,[3,1];case 4:return[2,null]}})}).call(this)}},{key:"getListedAssets",value:function(t){return W(function(){var r,n,a,i,o,s,u,l,c,f,h,d,m,y,p,b,g,v,w,S,k,A,E,I,O,x,C,T,j,z,P,L,D,R,U,M,B,q;return en(this,function(N){switch(N.label){case 0:r=new Date().toISOString(),n=new Set(t.flatMap(function(e){return[e.source.chainId,e.destination.chainId]})),a=[],i=new Set,o=!0,s=!1,u=void 0,N.label=1;case 1:N.trys.push([1,10,11,12]),l=n[Symbol.iterator](),N.label=2;case 2:if(o=(c=l.next()).done)return[3,9];if(!(f=String(c.value)))return[3,8];if((h=this.tokenListCache.get(f))&&Date.now()-h.fetchedAt<e.TOKEN_LIST_TTL){d=!0,m=!1,y=void 0;try{for(p=h.assets[Symbol.iterator]();!(d=(b=p.next()).done);d=!0)g=b.value,v="".concat(f,":").concat(g.assetId.toLowerCase()),i.has(v)||(i.add(v),a.push(g))}catch(e){m=!0,y=e}finally{try{d||null==p.return||p.return()}finally{if(m)throw y}}return[3,8]}N.label=3;case 3:return N.trys.push([3,7,,8]),[4,this.rateLimiter.acquire()];case 4:return N.sent(),[4,fetch("".concat(this.dlnApiBase,"/token-list?chainId=").concat(encodeURIComponent(f)),{headers:{Accept:"application/json"},signal:AbortSignal.timeout(this.timeout)})];case 5:if(!(w=N.sent()).ok)return this.logger.warn("Token list fetch failed",{chainId:f,status:w.status}),[3,8];return[4,w.json()];case 6:if(!(k=null==(S=N.sent())?void 0:S.tokens))return[3,8];A=[],E=!0,I=!1,O=void 0;try{for(x=Object.values(k)[Symbol.iterator]();!(E=(C=x.next()).done);E=!0)(null==(T=C.value)?void 0:T.address)&&(j=T.address.toLowerCase(),z="".concat(f,":").concat(j),i.has(z)||(i.add(z),L="number"==typeof T.decimals?T.decimals:Number.parseInt(String(null!=(P=T.decimals)?P:"18"),10),D=Number.isFinite(L)?L:18,U={chainId:f,assetId:j,symbol:null!=(R=T.symbol)?R:T.address,decimals:D},A.push(U),a.push(U)))}catch(e){I=!0,O=e}finally{try{E||null==x.return||x.return()}finally{if(I)throw O}}return this.tokenListCache.set(f,{assets:A,fetchedAt:Date.now()}),this.logger.info("Token list fetched",{chainId:f,tokenCount:A.length}),[3,8];case 7:return B=Z(M=N.sent(),Error)?M.message:String(M),this.logger.warn("Token list fetch failed",{chainId:f,error:B}),[3,8];case 8:return o=!0,[3,2];case 9:return[3,12];case 10:return q=N.sent(),s=!0,u=q,[3,12];case 11:try{o||null==l.return||l.return()}finally{if(s)throw u}return[7];case 12:return[2,{assets:a,measuredAt:r}]}})}).call(this)}},{key:"ping",value:function(){var e=this;return a.Effect.tryPromise({try:function(){return W(function(){return en(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,O.fetchWithRetry("".concat(this.dlnApiBase,"/supported-chains-info"),{headers:this.apiKey?{Authorization:"Bearer ".concat(this.apiKey)}:{}},1,500)];case 1:return e.sent(),[3,3];case 2:return console.warn("[deBridge] Health check warning:",e.sent()),[3,3];case 3:return[2,{status:"ok",timestamp:new Date().toISOString()}]}})}).call(e)},catch:function(e){return Error("Health check failed: ".concat(Z(e,Error)?e.message:String(e)))}})}},{key:"fetchDefiLlamaVolumes",value:function(){return W(function(){var e,t,r,n,a,i,o;return en(this,function(s){switch(s.label){case 0:if(this.volumeCache&&Date.now()-this.volumeCache.fetchedAt<this.VOLUME_CACHE_TTL)return[2,this.volumeCache.data];e=this.defillamaBaseUrl.replace(/\/$/,""),t="".concat(e,"/bridge/").concat(this.DEBRIDGE_LLAMA_ID),s.label=1;case 1:return s.trys.push([1,5,,6]),[4,this.rateLimiter.acquire()];case 2:return s.sent(),[4,fetch(t,{headers:{Accept:"application/json"},signal:AbortSignal.timeout(this.timeout)})];case 3:if(!(r=s.sent()).ok)return this.logger.error("DefiLlama API error",{status:r.status,url:t}),this.volumeCache={data:null,fetchedAt:Date.now()},[2,null];return[4,r.json()];case 4:if(n=s.sent(),!(a=this.parseDefiLlamaResponse(n)))return this.logger.warn("DefiLlama response missing required fields"),this.volumeCache={data:null,fetchedAt:Date.now()},[2,null];return this.volumeCache={data:a,fetchedAt:Date.now()},[2,a];case 5:return o=Z(i=s.sent(),Error)?i.message:String(i),this.logger.error("DefiLlama request failed",{url:t,error:o}),[2,null];case 6:return[2]}})}).call(this)}},{key:"parseDefiLlamaResponse",value:function(e){if(!e||(void 0===e?"undefined":et(e))!=="object")return null;var t,r,n,a=function(e){if("number"==typeof e&&Number.isFinite(e))return e;if("string"==typeof e){var t=Number.parseFloat(e);return Number.isFinite(t)?t:null}return null},i=a(e.lastDailyVolume),o=a(null!=(t=e.weeklyVolume)?t:e.lastWeeklyVolume),s=a(null!=(r=e.monthlyVolume)?r:e.lastMonthlyVolume);if(null===i||null===o||null===s)return null;var u="string"==typeof e.id?e.id:String(null!=(n=e.id)?n:""),l="string"==typeof e.displayName?e.displayName:u;return{id:u,displayName:l,lastDailyVolume:i,weeklyVolume:o,monthlyVolume:s}}},{key:"sanitizeHttpUrl",value:function(e,t){try{var r=e.replace(/\/$/,""),n=new URL(r);if("http:"!==n.protocol&&"https:"!==n.protocol)return console.warn("[deBridge] Invalid protocol ".concat(n.protocol,", using fallback")),t;return r}catch(r){return console.warn("[deBridge] Invalid URL ".concat(e,", using fallback:"),r),t}}},{key:"getRouteIntelligence",value:function(e){return W(function(){var t,r,n,a,i,o,s,u,l,c;return en(this,function(f){switch(f.label){case 0:t=[],r=new Date().toISOString(),n=!0,a=!1,i=void 0,f.label=1;case 1:f.trys.push([1,6,7,8]),s=function(){var e,n,a,i,s,u,c,f,h,d,m,y,p,b,g,v,w,S,k,A,E,I,O,x,C,T,j,z;return en(this,function(P){switch(P.label){case 0:e=l.value,P.label=1;case 1:P.trys.push([1,14,,15]),n=[1e3,5e3,1e4,5e4,1e5,5e5,1e6,5e6],a=e.source.decimals,i=[],s=!0,u=!1,c=void 0,P.label=2;case 2:P.trys.push([2,11,12,13]),f=n[Symbol.iterator](),P.label=3;case 3:if(s=(h=f.next()).done)return[3,10];m=String(Math.floor((d=h.value)*Math.pow(10,a))),P.label=4;case 4:return P.trys.push([4,6,,7]),[4,o.fetchQuoteWithRetry(e.source,e.destination,m)];case 5:if(!(y=P.sent())||!y.estimation)return i.push({amountUsd:d,effectiveRate:0,failed:!0}),[3,10];return p=Number(y.estimation.dstChainTokenOut.amount)/Number(y.estimation.srcChainTokenIn.amount),i.push({amountUsd:d,effectiveRate:p,failed:!1}),[3,7];case 6:return P.sent(),i.push({amountUsd:d,effectiveRate:0,failed:!0}),[3,10];case 7:return[4,new Promise(function(e){return setTimeout(e,200)})];case 8:P.sent(),P.label=9;case 9:return s=!0,[3,3];case 10:return[3,13];case 11:return b=P.sent(),u=!0,c=b,[3,13];case 12:try{s||null==f.return||f.return()}finally{if(u)throw c}return[7];case 13:if(v=(g=i.filter(function(e){return!e.failed})).length>0?g[g.length-1].amountUsd:null,w=null,g.length>=2&&(k=(S=g.map(function(e){return e.effectiveRate})).reduce(function(e,t){return e+t},0)/S.length,w=Math.max(0,Math.min(100,100-Math.sqrt(S.reduce(function(e,t){return e+Math.pow(t-k,2)},0)/S.length)/k*100))),A=null,g.length>=2){var L;I=(E=Math).max.apply(E,function(e){if(Array.isArray(e))return H(e)}(L=g.map(function(e){return e.effectiveRate}))||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(L)||er(L)||function(){throw TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),(O=g.filter(function(e){return e.effectiveRate>=.99*I})).length>0&&(A={min:O[0].amountUsd,max:O[O.length-1].amountUsd})}return x=g.find(function(e){return 1e3===e.amountUsd}),C=g.find(function(e){return 1e4===e.amountUsd}),T=g.find(function(e){return 1e5===e.amountUsd}),j={at1k:x?0:null,at10k:x&&C?Math.round((1-C.effectiveRate/x.effectiveRate)*1e4):null,at100k:x&&T?Math.round((1-T.effectiveRate/x.effectiveRate)*1e4):null},t.push({route:e,maxCapacityUsd:v,optimalRangeUsd:A,feeEfficiencyScore:w,priceImpactBps:j,measuredAt:r}),o.logger.info("Route intelligence analyzed",{route:"".concat(e.source.symbol,"->").concat(e.destination.symbol),maxCapacityUsd:v,feeEfficiencyScore:w}),[3,15];case 14:return z=P.sent(),o.logger.warn("Route intelligence analysis failed",{route:"".concat(e.source.symbol,"->").concat(e.destination.symbol),error:Z(z,Error)?z.message:String(z)}),t.push({route:e,maxCapacityUsd:null,optimalRangeUsd:null,feeEfficiencyScore:null,priceImpactBps:{at1k:null,at10k:null,at100k:null},measuredAt:r}),[3,15];case 15:return[2]}})},u=e[Symbol.iterator](),f.label=2;case 2:if(n=(l=u.next()).done)return[3,5];return o=this,[5,ea(s())];case 3:f.sent(),f.label=4;case 4:return n=!0,[3,2];case 5:return[3,8];case 6:return c=f.sent(),a=!0,i=c,[3,8];case 7:try{n||null==u.return||u.return()}finally{if(a)throw i}return[7];case 8:return[2,t]}})}).call(this)}}]),e}();function es(e,t,r,n,a,i,o){try{var s=e[i](o),u=s.value}catch(e){r(e);return}s.done?t(u):Promise.resolve(u).then(n,a)}function eu(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var i=e.apply(t,r);function o(e){es(i,n,a,o,s,"next",e)}function s(e){es(i,n,a,o,s,"throw",e)}o(void 0)})}}function el(e,t){var r,n,a,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},o=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return o.next=s(0),o.throw=s(1),o.return=s(2),"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(s){return function(u){var l=[s,u];if(r)throw TypeError("Generator is already executing.");for(;o&&(o=0,l[0]&&(i=0)),i;)try{if(r=1,n&&(a=2&l[0]?n.return:l[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,l[1])).done)return a;switch(n=0,a&&(l=[2&l[0],a.value]),l[0]){case 0:case 1:a=l;break;case 4:return i.label++,{value:l[1],done:!1};case 5:i.label++,n=l[1],l=[0];continue;case 7:l=i.ops.pop(),i.trys.pop();continue;default:if(!(a=(a=i.trys).length>0&&a[a.length-1])&&(6===l[0]||2===l[0])){i=0;continue}if(3===l[0]&&(!a||l[1]>a[0]&&l[1]<a[3])){i.label=l[1];break}if(6===l[0]&&i.label<a[1]){i.label=a[1],a=l;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(l);break}a[2]&&i.ops.pop(),i.trys.pop();continue}l=t.call(e,i)}catch(e){l=[6,e],n=0}finally{r=a=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}}}Y(eo,"DEFAULT_BASE_URL","https://dln.debridge.finance/v1.0"),Y(eo,"DEFAULT_DEFILLAMA_BASE_URL","https://bridges.llama.fi"),Y(eo,"DEFAULT_ACCOUNT","0x1111111111111111111111111111111111111111"),Y(eo,"TOKEN_LIST_TTL",3e5);let ec=(0,n.createPlugin)({id:"@near-intents/debridge-data-provider",variables:i.z.object({baseUrl:i.z.string().url().default("https://dln.debridge.finance/v1.0"),defillamaBaseUrl:i.z.string().url().default("https://bridges.llama.fi"),timeout:i.z.number().min(1e3).max(6e4).default(3e4),maxRequestsPerSecond:i.z.number().min(1).max(100).default(10)}),secrets:i.z.object({apiKey:i.z.string().default("not-required")}),contract:y,initialize:function(e){return a.Effect.gen(function(){var t,r,n;return el(this,function(i){switch(i.label){case 0:return n=new eo(e.variables.baseUrl,e.variables.defillamaBaseUrl,null!=(r=null==(t=e.secrets)?void 0:t.apiKey)?r:"not-required",e.variables.timeout,e.variables.maxRequestsPerSecond),[5,function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}(a.Effect.catchAll(n.ping(),function(e){return a.Effect.sync(function(){var t;console.warn("[deBridge] Ping failed during initialization:",(null!=(t=Error)&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):e instanceof t)?e.message:String(e))})}))];case 1:return i.sent(),[2,{service:n}]}})})},shutdown:function(){return a.Effect.void},createRouter:function(e,t){var r=e.service;return{getSnapshot:t.getSnapshot.handler(function(e){var t=e.input;return eu(function(){return el(this,function(e){switch(e.label){case 0:return[4,a.Effect.runPromise(r.getSnapshot(t))];case 1:return[2,e.sent()]}})})()}),ping:t.ping.handler(function(){return eu(function(){return el(this,function(e){switch(e.label){case 0:return[4,a.Effect.runPromise(r.ping())];case 1:return[2,e.sent()]}})})()})}}})}};
//# sourceMappingURL=900.js.map